<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <select id="modalidade">
      <option value="semModalidade" selected disabled>
        Escolha a modalidade
      </option></select
    ><br />
    <select id="cidade">
      <option value="semCidade" selected disabled>
        Escolha a cidade
      </option></select
    ><br />
    <select id="unidade">
      <option value="semUnidade" selected disabled>
        Escolha a unidade
      </option></select
    ><br />
    <select id="curso">
      <option value="semCurso" selected disabled>Escolha seu curso</option>
    </select>
    <p id="demo"></p>
    <a href="" target="_blank">SAIBA MAIS</a>
  </body>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script>
    $(document).ready(function () {
      $.getJSON("data.json", function (data) {
        $.each(data, function (i, obj) {
          console.log(obj);
          $("#modalidade").append(
            $("<option>", {
              value: obj.valor,
              text: obj.titulo,
            })
          );
        });

        $("#modalidade").change(function () {
          //Pegando o novo valor selecionado no combo
          var valor = $(this).val();
          if (valor == "ibmecOnline") {
            $("#cidade").hide();
            $("#unidade").hide();
          } else {
            $("#cidade").show();
            $("#unidade").show();
          }
          console.log("valor: " + valor);

          $.getJSON("data.json", function (data) {
            $.each(data, function (i, obj) {
              console.log("obj: ", obj);
              if (valor === obj.valor) {
                var dados = obj.data;
                $("#curso option").remove();
                $("#curso").append(
                  $("<option>", {
                    value: "semCurso",
                    text: "Escolha seu curso",
                    selected: true,
                    disabled: true,
                  })
                );
                // Monta combo cursos
                $.each(dados, function (i, curso) {
                  // console.log("curso", curso);
                  $("#curso").append(
                    $("<option>", {
                      value: i,
                      text: curso.NomeCurso,
                    })
                  );
                  // Cria link para cursos online
                  $("#curso").change(function () {
                    var cursoSelecionado = $("#curso :selected").text();
                    if (cursoSelecionado === curso.NomeCurso) {
                      $("a").attr("href", curso.link);
                    }
                  });
                });

                // Monta combo cidades
                var cidades = [];
                $.each(dados, function (i, cidade) {
                  for (var i = 0; i < cidade.listaCidadesComPolo.length; i++) {
                    console.log(cidade.listaCidadesComPolo[i]);
                    var codigoMunicipio =
                      cidade.listaCidadesComPolo[i].CodMunicipio;
                    // console.log("cÃ³digo: ", codigoMunicipio);
                    var nomeMunicipio =
                      cidade.listaCidadesComPolo[i].NomeMunicipio;
                    // console.log("cidade: " + nomeMunicipio);
                    var uf = cidade.listaCidadesComPolo[i].UF;
                    // console.log("uf: ", uf);
                    var testeCidade = cidades.push(
                      cidade.listaCidadesComPolo[i].NomeMunicipio
                    );
                  }

                  // Monta combo unidades
                  $("#cidade").change(function () {
                    var cidadeSelecionada = $("#cidade :selected").text();
                    console.log("cidadeSelecionada: " + cidadeSelecionada);

                    if (cidadeSelecionada === nomeMunicipio) {
                      var unidadeFederativa = uf;
                      console.log("UF: ", unidadeFederativa);

                      $("#unidade option").remove();

                      $("#unidade").append(
                        $("<option>", {
                          value: codigoMunicipio,
                          text: nomeMunicipio,
                        })
                      );

                      console.log("codMunicipio: ", codigoMunicipio);
                      console.log("nomeMunicipio: ", nomeMunicipio);

                      var url = "https://posgraduacao.ibmec.br/";

                      // $("a").attr("href", curso.link);
                      console.log(url + "?uf=" + unidadeFederativa);

                      // LINK PRESENCIAL QUASE TERMNADO
                      $("a").attr(
                        "href",
                        url +
                          "?uf=" +
                          unidadeFederativa +
                          "&curso=" +
                          codCurso +
                          "&cidade=" +
                          codigoMunicipio +
                          "&campus=" +
                          codCampus
                      );
                    }
                  });
                });

                // Monta array sem duplicidade
                function pqp(list) {
                  var result = [];
                  $("#cidade option").remove();
                  $.each(list, function (i, cidade) {
                    if ($.inArray(cidade, result) == -1) {
                      result.push(cidade);
                      $("#cidade").append(
                        $("<option>", {
                          value: i,
                          text: cidade,
                        })
                      );
                    }
                  });
                  console.log("cidades: ", result);
                }
                pqp(cidades);
              }
            });
          });
          // carregaCombo2(curso);
        });
      });
    });
  </script>
</html>
